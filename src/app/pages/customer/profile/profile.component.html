<div class="profile-layout">
  <!-- Sidebar -->
  <app-account-sidebar></app-account-sidebar>

  <!-- Main Profile Section -->
  <div class="profile-main">
    <div class="profile-wrapper" *ngIf="profileForm">
      <div class="profile-header">
        <h2>My Profile</h2>
        <p class="subtitle">Manage and protect your account</p>
      </div>

      <div class="profile-content">
        <!-- LEFT: Profile Form -->
        <form [formGroup]="profileForm" class="profile-form">
          <div class="form-group">
            <label>Name</label>
            <div class="field-inline">
              <ng-container *ngIf="!editMode.name; else editName">
                <input
                  [value]="(profileForm.get('firstName')?.value || '') + ' ' + (profileForm.get('lastName')?.value || '')"
                  readonly
                  class="readonly"
                  [class.is-invalid]="(profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched) || 
                                    (profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched)"
                />
                <a (click)="editMode.name = true" class="action-link">Change</a>
              </ng-container>

              <ng-template #editName>
                <div class="field-inline" style="gap: 8px;">
                  <div class="input-group">
                    <input 
                      formControlName="firstName" 
                      placeholder="First Name"
                      [class.is-invalid]="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched"
                    />
                    <div class="invalid-feedback" *ngIf="profileForm.get('firstName')?.touched">
                      {{ getErrorMessage('firstName') }}
                    </div>
                  </div>
                  <div class="input-group">
                    <input 
                      formControlName="lastName" 
                      placeholder="Last Name"
                      [class.is-invalid]="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched"
                    />
                    <div class="invalid-feedback" *ngIf="profileForm.get('lastName')?.touched">
                      {{ getErrorMessage('lastName') }}
                    </div>
                  </div>
                  <div class="action-buttons">
                    <a (click)="cancelEdit('name')" class="action-link cancel">Cancel</a>
                  </div>
                </div>
              </ng-template>
            </div>
          </div>

          <div class="form-group">
            <label>Email</label>
            <div class="field-inline">
              <ng-container *ngIf="!editMode.email; else editEmail">
                <input 
                  formControlName="email" 
                  readonly 
                  class="readonly"
                  [class.is-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched"
                />
                <a (click)="editMode.email = true" class="action-link">Change</a>
              </ng-container>

              <ng-template #editEmail>
                <div class="input-group flex-grow-1">
                  <input 
                    formControlName="email" 
                    class="editable"
                    [class.is-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched"
                  />
                  <div class="invalid-feedback" *ngIf="profileForm.get('email')?.touched">
                    {{ getErrorMessage('email') }}
                  </div>
                </div>
                <a (click)="cancelEdit('email')" class="action-link cancel">Cancel</a>
              </ng-template>
            </div>
          </div>

          <div class="form-group">
            <label>Phone Number</label>
            <div class="field-inline">
              <ng-container *ngIf="!editMode.phone; else editPhone">
                <input 
                  [value]="(profileForm.get('mobileCode')?.value || '') + ' ' + (profileForm.get('mobileNumber')?.value || '')" 
                  readonly 
                  class="readonly"
                  [class.is-invalid]="(profileForm.get('mobileCode')?.invalid && profileForm.get('mobileCode')?.touched) ||
                                    (profileForm.get('mobileNumber')?.invalid && profileForm.get('mobileNumber')?.touched)"
                />
                <a (click)="editMode.phone = true" class="action-link">Change</a>
              </ng-container>

              <ng-template #editPhone>
                <div class="field-inline flex-grow-1" style="gap: 8px;">
                  <div class="input-group" style="width: 100px;">
                    <input 
                      formControlName="mobileCode" 
                      style="width: 100%;"
                      [class.is-invalid]="profileForm.get('mobileCode')?.invalid && profileForm.get('mobileCode')?.touched"
                    />
                    <div class="invalid-feedback" *ngIf="profileForm.get('mobileCode')?.touched">
                      {{ getErrorMessage('mobileCode') }}
                    </div>
                  </div>
                  <div class="input-group flex-grow-1">
                    <input 
                      formControlName="mobileNumber"
                      [class.is-invalid]="profileForm.get('mobileNumber')?.invalid && profileForm.get('mobileNumber')?.touched"
                    />
                    <div class="invalid-feedback" *ngIf="profileForm.get('mobileNumber')?.touched">
                      {{ getErrorMessage('mobileNumber') }}
                    </div>
                  </div>
                </div>
                <a (click)="cancelEdit('phone')" class="action-link cancel">Cancel</a>
              </ng-template>
            </div>
          </div>

          <div class="form-group">
            <label>Gender</label>
            <div class="radio-group">
              <label>
                <input 
                  type="radio" 
                  formControlName="gender" 
                  value="Male" 
                  (change)="profileForm.markAsDirty()" 
                /> Male
              </label>
              <label>
                <input 
                  type="radio" 
                  formControlName="gender" 
                  value="Female" 
                  (change)="profileForm.markAsDirty()" 
                /> Female
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Date of Birth</label>
            <div class="field-inline">
              <ng-container *ngIf="!editMode.dob; else editDob">
                <span>{{ profileForm.get('dob')?.value | date: 'MMM d, y' }}</span>
                <a (click)="editMode.dob = true" class="action-link">Change</a>
              </ng-container>

              <ng-template #editDob>
                <input type="date" formControlName="dob" class="editable" />
                <a (click)="cancelEdit('dob')" class="action-link cancel">Cancel</a>
              </ng-template>
            </div>
          </div>

          <button
            type="button"
            class="save-button"
            [disabled]="!profileForm.valid || !profileForm.dirty"
            (click)="onSave()"
          >
            Save
          </button>
        </form>

        <!-- RIGHT: Avatar Upload -->
        <div class="profile-avatar">
          <img [src]="'https://ui-avatars.com/api/?name=' + 
                      (profileForm.get('firstName')?.value || '') + '+' + 
                      (profileForm.get('lastName')?.value || '') + 
                      '&background=random'" 
               alt="Avatar" />
          <button class="upload-button">Select Image</button>
          <small>File size: max 1 MB<br />File format: .JPEG, .PNG</small>
        </div>
      </div>
    </div>
  </div>
</div>
